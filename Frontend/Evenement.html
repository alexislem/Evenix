<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Événement – Evenix</title>
  <link rel="stylesheet" href="css/Evenement.css" />
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header class="site-header">
    <div class="container header-wrap">
      <a href="Accueil.html" class="brand">Evenix</a>
      <nav class="nav">
        <a href="Accueil.html">Accueil</a>
        <a href="ListeEvenement.html" aria-current="page">Événements</a>
        <a href="A-propos.html">À propos</a>
        <a href="Contact.html">Contact</a>
        <a href="Panier.html" class="nav-cart" id="cart-link">
          <span>Panier</span>
          <span class="cart-badge" id="cart-badge" hidden>0</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <!-- ===== Lien de retour ===== -->
    <div class="container back-wrap">
      <a class="back-link" id="back-link" href="ListeEvenement.html">← Retour aux événements</a>
    </div>

    <!-- ===== FICHE ÉVÉNEMENT ===== -->
    <section class="section">
      <div class="container event">
        <div class="event-media">
          <img id="event-img" src="image/evenement.png" alt="Affiche de l'événement" class="event-img" />
        </div>

        <div class="event-info">
          <h1 class="event-title" id="event-title">Titre…</h1>
          <p class="event-price" id="event-price">—</p>

          <p class="event-desc" id="event-desc">—</p>

          <div class="event-meta">
            <p class="event-datetime"><strong>Date/Heure :</strong> <span id="event-datetime">—</span></p>
            <p class="event-lieu"><strong>Lieu :</strong> <span id="event-lieu">—</span></p>
          </div>

          <div class="event-actions">
            <label for="qty" class="qty-label">Quantité</label>
            <div class="qty-control">
              <button type="button" class="qty-btn" aria-label="Diminuer">−</button>
              <input id="qty" name="qty" type="number" min="1" value="1" inputmode="numeric" />
              <button type="button" class="qty-btn" aria-label="Augmenter">+</button>
            </div>
          </div>

          <button class="btn btn-primary add-to-cart" type="button">
            Ajouter au panier
          </button>
        </div>
      </div>
    </section>

    <div class="container" id="status" style="display:none;"></div>

    <!-- ===== LIEUX À PROXIMITÉ ===== -->
    <section class="section" id="nearby-section" style="display:none;">
      <div class="container">
        <h2 class="section-title">À visiter à proximité</h2>
        <div class="grid cards" id="nearby-grid"></div>
      </div>
    </section>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="site-footer">
    <div class="container footer-wrap">
      <div class="footer-brand">Evenix</div>
      <div class="footer-col">
        <h4>Localisation</h4>
        <p>1 rue de Paris<br>Paris, 75001</p>
      </div>
      <div class="footer-col">
        <h4>Contact</h4>
        <p>contact@evenix.com<br>07 98 45 76 21</p>
      </div>
    </div>
    <div class="container footer-bottom">
      <p>&copy; 2025 Evenix — Tous droits réservés.</p>
    </div>
  </footer>

  <!-- ===== quantité +/- ===== -->
  <script>
    const minus = document.querySelectorAll('.qty-btn')[0];
    const plus  = document.querySelectorAll('.qty-btn')[1];
    const input = document.getElementById('qty');
    minus?.addEventListener('click', () => {
      const v = Math.max(1, parseInt(input.value || '1', 10) - 1);
      input.value = v;
    });
    plus?.addEventListener('click', () => {
      const v = Math.max(1, parseInt(input.value || '1', 10) + 1);
      input.value = v;
    });
  </script>

  <!-- ===== ÉVÉNEMENT + LIEUX PROCHES ===== -->
  <script>
  (async () => {
    const GEO_KEY = "471755b09461446b977bd2caa1a75d4d"; // <-- remplace par ta clé

    // ---------- Utils ----------
    const esc = s => (s ?? '').toString().replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]
    ));
    const fmtPrice = (payant, prix) => payant ? `${Number(prix ?? 0).toFixed(2)} €` : 'Gratuit';
    const fmtDate = iso => iso ? new Date(iso).toLocaleString('fr-FR', {
      day:'2-digit', month:'2-digit', year:'numeric',
      hour:'2-digit', minute:'2-digit'
    }) : '';
    const getParam = (k) => new URLSearchParams(location.search).get(k);

    const containsCity = (txt, city) => new RegExp(`\\b${city}\\b`, 'i').test(txt || '');

    function normalizeUrl(u) {
      if (!u) return '';
      try {
        if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
        return new URL(u).href;
      } catch { return ''; }
    }
    function buildFallbackLink(p) {
      const hasCoords = Number.isFinite(p.lat) && Number.isFinite(p.lon);
      if (hasCoords) {
        return `https://www.openstreetmap.org/?mlat=${p.lat}&mlon=${p.lon}#map=17/${p.lat}/${p.lon}`;
      }
      const q = [p.name, p.address].filter(Boolean).join(' ');
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
    }

    // ---------- 1) Chargement de l'événement ----------
    const id = getParam('id');
    const status = document.getElementById('status');
    if (!id) {
      status.style.display = 'block';
      status.textContent = "Identifiant d'événement manquant dans l'URL.";
      return;
    }

    const API = 'http://localhost:8080/api/evenement/' + encodeURIComponent(id);

    let ev = null;
    try {
      const res = await fetch(API, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      ev = await res.json();
    } catch (err) {
      console.error('[event] load error', err);
      status.style.display = 'block';
      status.textContent = "Impossible de charger l'événement.";
      return;
    }

    // Remplissage DOM
    document.getElementById('event-title').textContent = ev.nom ?? 'Événement';
    document.getElementById('page-title').textContent  = `${ev.nom ?? 'Événement'} – Evenix`;
    document.getElementById('event-price').textContent = fmtPrice(ev.payant, ev.prix);
    document.getElementById('event-desc').textContent  = ev.description || '—';
    document.getElementById('event-datetime').textContent = fmtDate(ev.dateDebut);

    const lieuParts = [];
    if (ev?.lieu?.nom)     lieuParts.push(ev.lieu.nom);
    if (ev?.lieu?.adresse) lieuParts.push(ev.lieu.adresse);
    document.getElementById('event-lieu').textContent = (lieuParts.join(' – ') || '—');

    const img = ev.imageUrl || 'image/evenement.png';
    const imgEl = document.getElementById('event-img');
    imgEl.src = img; imgEl.alt = `Affiche – ${ev.nom ?? 'Événement'}`;
    document.getElementById('back-link').href = 'ListeEvenement.html';

    // ---------- 2) Géocodage robuste ----------
    const CORE_CULTURE = ["entertainment.museum","tourism.sights","tourism.attraction"];
    const SOFT_EXPANSIONS = [["entertainment.zoo","entertainment.theme_park"],["leisure.park"]];

    function guessCityFallback(ev) {
      const text = `${ev?.nom || ''} ${ev?.description || ''} ${ev?.lieu?.adresse || ''}`;
      if (containsCity(text, 'Paris')) return 'Paris';
      return '';
    }

    async function geocodeIfNeeded(ev) {
      let lat = Number(ev?.lieu?.latitude), lon = Number(ev?.lieu?.longitude);
      if (Number.isFinite(lat) && Number.isFinite(lon) && lat !== 0 && lon !== 0) {
        console.log('[geo] using DB coords', {lat, lon});
        return { lat, lon };
      }

      const nom      = (ev?.lieu?.nom || '').trim();
      const adresse  = (ev?.lieu?.adresse || '').trim();
      const ville    = (ev?.lieu?.ville || '').trim() || guessCityFallback(ev);
      const cp       = (ev?.lieu?.codePostal || '').toString().trim();
      const pays     = (ev?.lieu?.pays || 'France').trim();

      const text = [adresse || nom].filter(Boolean).join(', ');

      if (!text && !ville) return null;

      const params = new URLSearchParams({
        apiKey: GEO_KEY,
        limit: '1',
        lang: 'fr'
      });
      if (text) params.set('text', text);
      if (ville) params.set('city', ville);
      if (cp)    params.set('postcode', cp);
      if (pays)  params.set('country', pays);

      const url = `https://api.geoapify.com/v1/geocode/search?${params.toString()}`;
      console.log('[geo] url', url);

      try {
        const r = await fetch(url);
        if (!r.ok) { console.warn('[geo] HTTP', r.status); return null; }
        const data = await r.json();
        const p = data?.features?.[0]?.properties;
        if (p?.lat && p?.lon) {
          console.log('[geo] result', {lat:p.lat, lon:p.lon, city:p.city});
          return { lat: p.lat, lon: p.lon };
        }
      } catch (e) {
        console.warn('[geo] error', e);
      }
      return null;
    }

    async function fetchPlaces(categories, coords, radius = 8000) {
      const url =
        `https://api.geoapify.com/v2/places?categories=${categories.join(',')}` +
        `&filter=circle:${coords.lon},${coords.lat},${radius}` +
        `&bias=proximity:${coords.lon},${coords.lat}` +
        `&lang=fr&limit=24&apiKey=${GEO_KEY}`;

      const r = await fetch(url);
      if (!r.ok) {
        let info = ''; try { info = (await r.json())?.message || ''; } catch {}
        throw new Error(`Geoapify HTTP ${r.status}${info ? ' — ' + info : ''}`);
      }
      return (await r.json())?.features ?? [];
    }

    async function loadNearbyPlaces(ev) {
      const section = document.getElementById('nearby-section');
      const grid    = document.getElementById('nearby-grid');

      const coords = await geocodeIfNeeded(ev);
      if (!coords) {
        section.style.display = 'block';
        grid.innerHTML = "<p>Aucun lieu culturel trouvé à proximité (pas de coordonnées).</p>";
        return;
      }

      let features = [];
      try {
        features = await fetchPlaces(CORE_CULTURE, coords);
        for (const extra of SOFT_EXPANSIONS) {
          if (features.length) break;
          features = await fetchPlaces(CORE_CULTURE.concat(extra), coords);
        }
      } catch (e) {
        console.error('[nearby] error', e);
        section.style.display = 'block';
        grid.innerHTML = `<p>Impossible de charger les lieux à proximité (API). ${esc(e.message || '')}</p>`;
        return;
      }

      let pois = (features || []).map(f => {
        const p = f.properties || {};
        const website = normalizeUrl(p.website) || normalizeUrl(p.url) || '';
        const address = [p.address_line1, p.address_line2].filter(Boolean).join(', ');
        return {
          name: p.name || p.address_line1 || 'Lieu culturel',
          address,
          distance: p.distance ?? Infinity,
          website,
          lat: p.lat, lon: p.lon
        };
      });

      const seen = new Set();
      pois = pois.filter(p => {
        const key = (p.name + '|' + p.address).toLowerCase();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      pois.sort((a,b) => (a.distance ?? Infinity) - (b.distance ?? Infinity));
      pois = pois.slice(0, 8);

      section.style.display = 'block';
      if (!pois.length) {
        grid.innerHTML = "<p>Aucun lieu culturel trouvé à proximité.</p>";
        return;
      }

      const km = m => (m/1000).toFixed(1);
      grid.innerHTML = pois.map(p => {
        const href = p.website || buildFallbackLink(p);
        const dist = Number.isFinite(p.distance) ? ` — ${km(p.distance)} km` : '';
        return `
          <article class="card">
            <img class="card-media" src="image/evenement.png" alt="${esc(p.name)}">
            <div class="card-body">
              <h3 class="card-title">${esc(p.name)}${dist}</h3>
              ${p.address ? `<p class="card-meta">${esc(p.address)}</p>` : ''}
              <a class="btn btn-secondary" href="${esc(href)}" target="_blank" rel="noopener">Voir</a>
            </div>
          </article>
        `;
      }).join('');
    }

    await loadNearbyPlaces(ev);
  })();
  </script>

  <!-- ===== Panier ===== -->
  <script src="js/cart.js"></script>
  <script>
    document.querySelector('.add-to-cart')?.addEventListener('click', () => {
      const qty = Number(document.getElementById('qty')?.value || 1);
      const id    = new URLSearchParams(location.search).get('id');
      const name  = document.getElementById('event-title')?.textContent?.trim() || 'Événement';
      const priceTxt = document.getElementById('event-price')?.textContent || '0';
      const price = priceTxt.includes('Gratuit') ? 0 : Number(priceTxt.replace(/[^\d.,]/g,'').replace(',', '.')) || 0;
      const date  = document.getElementById('event-datetime')?.textContent || '';
      const lieu  = document.getElementById('event-lieu')?.textContent || '';

      EvenixCart.upsert({
        id: String(id),
        name,
        price,
        qty,
        meta: { date, lieu }
      });

      location.href = 'Panier.html';
    });
  </script>
</body>
</html>
